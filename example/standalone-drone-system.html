<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MapLibre 3Dãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿å®Œå…¨ç‰ˆ</title>
  <script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; height: 100vh; overflow: hidden; }
    #app { height: 100vh; display: flex; flex-direction: column; }
    #map { flex: 1; min-height: 0; }
    .controls { height: 300px; overflow-y: auto; padding: 20px; background: #f5f5f5; border-top: 1px solid #ddd; }
    .file-drop { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 10px 0; cursor: pointer; transition: all 0.3s; }
    .file-drop.dragover { border-color: #007cba; background: #e3f2fd; }
    .data-info { display: flex; gap: 20px; margin: 10px 0; }
    .info-box { padding: 10px; background: white; border-radius: 5px; flex: 1; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; background: #007cba; color: white; border: none; border-radius: 3px; transition: all 0.3s; }
    button:hover { background: #005a8a; transform: translateY(-1px); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .sample-data { font-size: 12px; color: #666; margin: 10px 0; }
    .drone-trail { opacity: 0.6; }
    .status { margin: 10px 0; padding: 10px; background: #e8f4f8; border-radius: 5px; font-size: 14px; }
    .object-list { max-height: 250px; overflow-y: auto; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
    .object-item { padding: 8px; margin: 0; background: white; border-bottom: 1px solid #eee; font-size: 12px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
    .object-item:hover { background: #f8f9fa; }
    .object-item:last-child { border-bottom: none; }
    .object-info { flex: 1; }
    .object-name { font-weight: bold; color: #333; margin-bottom: 2px; }
    .object-details { color: #666; font-size: 11px; }
    .object-actions { display: flex; gap: 5px; }
    .action-btn { background: #007cba; color: white; border: none; padding: 3px 8px; border-radius: 2px; cursor: pointer; font-size: 10px; transition: background 0.2s; }
    .action-btn:hover { background: #005a8a; }
    .delete-btn { background: #ff4444; }
    .delete-btn:hover { background: #cc3333; }
    .focus-btn { background: #28a745; }
    .focus-btn:hover { background: #1e7e34; }
    .type-badge { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-right: 5px; }
    .type-drone { background: #ffebee; color: #c62828; }
    .type-base { background: #fff3e0; color: #ef6c00; }
    .type-sensor { background: #e3f2fd; color: #1565c0; }
    .type-building { background: #e8f5e8; color: #2e7d32; }
    .type-weather { background: #f3e5f5; color: #7b1fa2; }
    .type-manual { background: #f5f5f5; color: #424242; }
    .type-flight { background: #ffebee; color: #d32f2f; }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>
     
    <div class="controls">
    <h3>ğŸ“ 3Dãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ãƒ»æ›¸ãå‡ºã—</h3>
    
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status" class="status">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†</div>
    
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«å–ã‚Šè¾¼ã¿ã‚¨ãƒªã‚¢ -->
    <div id="fileDropArea" class="file-drop">
      ğŸ“‚ 3Dãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ<br>
      <small>å¯¾å¿œå½¢å¼: CSV, GeoJSON, JSON</small>
    </div>
    <input type="file" id="fileInput" multiple accept=".csv,.json,.geojson" style="display: none;">
    
    <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ -->
    <div class="sample-data">
      <strong>CSVã‚µãƒ³ãƒ—ãƒ«å½¢å¼:</strong> longitude,latitude,altitude,name,type<br>
      <code>139.6917,35.6895,100,é£›è¡Œ001,flight</code>
    </div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿æƒ…å ± -->
    <div class="data-info">
      <div class="info-box">
        <strong>èª­ã¿è¾¼ã¿æ¸ˆã¿:</strong> <span id="loadedCount">0</span> ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      </div>
      <div class="info-box">
        <strong>è¡¨ç¤ºä¸­:</strong> <span id="visibleCount">0</span> ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      </div>
      <div class="info-box">
        <strong>é«˜åº¦ç¯„å›²:</strong> <span id="altitudeRange">-</span>
      </div>
    </div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
    <div>
      <button onclick="loadSampleData()">ğŸ¯ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
      <button onclick="startDroneSimulation()">ğŸš é£›è¡Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
      <button onclick="exportCSV()" id="exportCSVBtn">ğŸ“Š CSVæ›¸ãå‡ºã—</button>
      <button onclick="exportGeoJSON()" id="exportGeoJSONBtn">ğŸ—ºï¸ GeoJSONæ›¸ãå‡ºã—</button>
      <button onclick="clearAllData()">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
      <button onclick="toggle3D()">ğŸ”„ 2D/3Dåˆ‡ã‚Šæ›¿ãˆ</button>
      <button onclick="enableDrawMode()">âœï¸ æç”»ãƒ¢ãƒ¼ãƒ‰</button>
    </div>
    
    <!-- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ -->
    <div>
      <h4>ğŸ“ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h4>
      <div id="objectList" class="object-list"></div>
    </div>
  </div>
  </div>

  <script>
  // åœ°ç†é™¢DEMå¤‰æ›é–¢æ•°
  const gsidem2terrainrgb = (r, g, b) => {
      let height = r * 655.36 + g * 2.56 + b * 0.01;
      if (r === 128 && g === 0 && b === 0) {
          height = 0;
      } else if (r >= 128) {
          height -= 167772.16;
      }
      height += 100000;
      height *= 10;
      const tB = (height / 256 - Math.floor(height / 256)) * 256;
      const tG = (Math.floor(height / 256) / 256 - Math.floor(Math.floor(height / 256) / 256)) * 256;
      const tR = (Math.floor(Math.floor(height / 256) / 256) / 256 - Math.floor(Math.floor(Math.floor(height / 256) / 256) / 256)) * 256;
      return [tR, tG, tB];
  };

  // åœ°ç†é™¢DEMãƒ—ãƒ­ãƒˆã‚³ãƒ«ç™»éŒ²
  maplibregl.addProtocol('gsidem', (params, callback) => {
      const image = new Image();
      image.crossOrigin = '';
      image.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = image.width;
          canvas.height = image.height;
          const context = canvas.getContext('2d');
          context.drawImage(image, 0, 0);
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          for (let i = 0; i < imageData.data.length / 4; i++) {
              const tRGB = gsidem2terrainrgb(
                  imageData.data[i * 4],
                  imageData.data[i * 4 + 1],
                  imageData.data[i * 4 + 2],
              );
              imageData.data[i * 4] = tRGB[0];
              imageData.data[i * 4 + 1] = tRGB[1];
              imageData.data[i * 4 + 2] = tRGB[2];
          }
          context.putImageData(imageData, 0, 0);
          canvas.toBlob((blob) =>
              blob.arrayBuffer().then((arr) => callback(null, arr, null, null)),
          );
      };
      image.onerror = () => callback(new Error('DEMèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
      image.src = params.url.replace('gsidem://', '');
      return { cancel: () => {} };
  });

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let map;
  let loadedObjects = [];
  let is3D = true;
  let drawMode = false;
  let droneSimulationInterval;
  let sampleDataLoaded = false;

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  function setStatus(message) {
      document.getElementById('status').textContent = message;
      console.log(`[Status] ${message}`);
  }

  function generateRandomPosition(center, radius) {
      const angle = Math.random() * 2 * Math.PI;
      const distance = Math.random() * radius;
      return [
          center[0] + (distance * Math.cos(angle)) / 111320,
          center[1] + (distance * Math.sin(angle)) / 110540
      ];
  }

  // ãƒãƒƒãƒ—åˆæœŸåŒ–
  function initializeMap() {
      setStatus('ãƒãƒƒãƒ—åˆæœŸåŒ–ä¸­...');
      
      // ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
          console.error('ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          setStatus('ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠã‚¨ãƒ©ãƒ¼');
          return;
      }
      
      map = new maplibregl.Map({
          container: 'map',
          maxPitch: 85,
          center: [138.69, 35.3],
          zoom: 12,
          pitch: 70,
          style: {
              version: 8,
              sources: {
                  gsi: {
                      type: 'raster',
                      tiles: ['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],
                      attribution: 'åœ°ç†é™¢ã‚¿ã‚¤ãƒ«',
                  },
                  gsidem: {
                      type: 'raster-dem',
                      tiles: ['gsidem://https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png'],
                      tileSize: 256,
                      maxzoom: 14,
                  },
                  'objects-3d': {
                      type: 'geojson',
                      data: { type: 'FeatureCollection', features: [] }
                  },
                  'drone-trails': {
                      type: 'geojson',
                      data: { type: 'FeatureCollection', features: [] }
                  }
              },
              layers: [
                  {
                      id: 'gsi',
                      type: 'raster',
                      source: 'gsi',
                  }
              ],
              terrain: {
                  source: 'gsidem',
                  exaggeration: 1.2,
              },
          },
      });

      map.on('load', () => {
          setupMapLayers();
          setupMapEvents();
          setStatus('ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
      });

      map.on('error', (e) => {
          console.error('MapLibreã‚¨ãƒ©ãƒ¼:', e);
          setStatus('ãƒãƒƒãƒ—ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ');
      });
  }

  // ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
  function setupMapLayers() {
      console.log('ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šé–‹å§‹');
      
      try {
          // ãƒ‰ãƒ­ãƒ¼ãƒ³è»Œè·¡ãƒ¬ã‚¤ãƒ¤ãƒ¼
          map.addLayer({
              id: 'drone-trails-layer',
              type: 'line',
              source: 'drone-trails',
              paint: {
                  'line-color': '#ff6b6b',
                  'line-width': 2,
                  'line-opacity': 0.6
              }
          });

          // 3DæŠ¼ã—å‡ºã—ãƒ¬ã‚¤ãƒ¤ãƒ¼
          map.addLayer({
              id: 'objects-3d-layer',
              type: 'fill-extrusion',
              source: 'objects-3d',
              paint: {
                  'fill-extrusion-color': [
                      'match',
                      ['get', 'type'],
                      'drone', '#ff4444',
                      'building', '#44ff44', 
                      'sensor', '#4444ff',
                      'base', '#ffaa00',
                      'weather', '#ff44ff',
                      'manual', '#888888',
                      'flight', '#ff6b6b',
                      '#cccccc'
                  ],
                  'fill-extrusion-height': ['get', 'altitude'],
                  'fill-extrusion-base': 0,
                  'fill-extrusion-opacity': 0.8
              }
          });

          // ãƒã‚¤ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼
          map.addLayer({
              id: 'objects-points-layer',
              type: 'circle',
              source: 'objects-3d',
              paint: {
                  'circle-radius': [
                      'interpolate',
                      ['linear'],
                      ['zoom'],
                      8, 6,
                      16, 12
                  ],
                  'circle-color': [
                      'match',
                      ['get', 'type'],
                      'drone', '#ff4444',
                      'building', '#44ff44',
                      'sensor', '#4444ff', 
                      'base', '#ffaa00',
                      'weather', '#ff44ff',
                      'manual', '#888888',
                      'flight', '#ff6b6b',
                      '#cccccc'
                  ],
                  'circle-stroke-width': 2,
                  'circle-stroke-color': '#ffffff',
                  'circle-opacity': 0.9
              }
          });

          // åˆæœŸçŠ¶æ…‹ã§2Dãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’éè¡¨ç¤ºã«
          map.setLayoutProperty('objects-points-layer', 'visibility', 'none');

          console.log('ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šå®Œäº†');
      } catch (error) {
          console.error('ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
          setStatus('ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼');
      }
  }

  // ãƒãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  function setupMapEvents() {
      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒªãƒƒã‚¯
      map.on('click', 'objects-3d-layer', showObjectInfo);
      map.on('click', 'objects-points-layer', showObjectInfo);

      // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ï¼ˆæç”»ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼‰
      map.on('click', (e) => {
          if (drawMode) {
              addObjectAtLocation(e.lngLat);
          }
      });

      // ãƒ›ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
      map.on('mouseenter', 'objects-3d-layer', () => {
          map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'objects-3d-layer', () => {
          map.getCanvas().style.cursor = drawMode ? 'crosshair' : '';
      });
      
      map.on('mouseenter', 'objects-points-layer', () => {
          map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'objects-points-layer', () => {
          map.getCanvas().style.cursor = drawMode ? 'crosshair' : '';
      });
  }

  // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ 
  function addObjectAtLocation(lngLat) {
      const newObject = {
          id: `manual_${Date.now()}`,
          name: `æ‰‹å‹•è¿½åŠ _${loadedObjects.length + 1}`,
          longitude: lngLat.lng,
          latitude: lngLat.lat,
          altitude: 50 + Math.random() * 100,
          type: 'manual',
          source: 'manual'
      };
      
      loadedObjects.push(newObject);
      updateDisplay();
      setStatus(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ : ${newObject.name}`);
  }

  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
  function showObjectInfo(e) {
      const props = e.features[0].properties;
      new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
              <div style="padding: 10px;">
                  <h3 style="margin: 0 0 10px 0;">${props.name}</h3>
                  <p><strong>ã‚¿ã‚¤ãƒ—:</strong> ${props.type}</p>
                  <p><strong>é«˜åº¦:</strong> ${props.altitude}m</p>
                  <p><strong>åº§æ¨™:</strong> ${e.lngLat.lng.toFixed(6)}, ${e.lngLat.lat.toFixed(6)}</p>
                  <button onclick="removeObject('${props.id}')" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>
              </div>
          `)
          .addTo(map);
  }

  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
  function removeObject(objectId) {
      loadedObjects = loadedObjects.filter(obj => obj.id !== objectId);
      updateDisplay();
      setStatus(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤: ${objectId}`);
      
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
      const popups = document.getElementsByClassName('maplibregl-popup');
      for (let popup of popups) {
          popup.remove();
      }
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†è¨­å®š
  function setupFileHandling() {
      const fileInput = document.getElementById('fileInput');
      const dropArea = document.getElementById('fileDropArea');

      dropArea.addEventListener('click', () => fileInput.click());
      dropArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropArea.classList.add('dragover');
      });
      dropArea.addEventListener('dragleave', () => {
          dropArea.classList.remove('dragover');
      });
      dropArea.addEventListener('drop', (e) => {
          e.preventDefault();
          dropArea.classList.remove('dragover');
          handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', (e) => {
          handleFiles(e.target.files);
      });
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
  function handleFiles(files) {
      setStatus('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ä¸­...');
      let processedFiles = 0;
      
      Array.from(files).forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
              try {
                  if (file.name.endsWith('.csv')) {
                      parseCSV(e.target.result, file.name);
                  } else if (file.name.endsWith('.json') || file.name.endsWith('.geojson')) {
                      parseJSON(e.target.result, file.name);
                  }
                  
                  processedFiles++;
                  if (processedFiles === files.length) {
                      updateDisplay();
                      setStatus(`${files.length}ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†å®Œäº†`);
                  }
              } catch (error) {
                  console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                  setStatus(`ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
              }
          };
          reader.readAsText(file);
      });
  }

  // CSVè§£æ
  function parseCSV(csvText, filename) {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      let addedCount = 0;
      
      for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
          const obj = {};
          headers.forEach((header, index) => {
              obj[header] = values[index];
          });
          
          if (obj.longitude && obj.latitude) {
              const newObject = {
                  id: `${filename}_${i}_${Date.now()}`,
                  name: obj.name || `ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ${i}`,
                  longitude: parseFloat(obj.longitude),
                  latitude: parseFloat(obj.latitude),
                  altitude: parseFloat(obj.altitude || obj.height || obj.elevation) || 50,
                  type: obj.type || 'unknown',
                  source: filename
              };
              
              // é‡è¤‡ãƒã‚§ãƒƒã‚¯
              const exists = loadedObjects.some(existing => 
                  Math.abs(existing.longitude - newObject.longitude) < 0.00001 &&
                  Math.abs(existing.latitude - newObject.latitude) < 0.00001
              );
              
              if (!exists) {
                  loadedObjects.push(newObject);
                  addedCount++;
              }
          }
      }
      console.log(`CSVè§£æå®Œäº†: ${filename} ã‹ã‚‰ ${addedCount}ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ `);
  }

  // JSONè§£æ
  function parseJSON(jsonText, filename) {
      const data = JSON.parse(jsonText);
      let objects = [];
      
      if (data.type === 'FeatureCollection') {
          objects = data.features.map((feature, index) => ({
              id: `${filename}_${index}_${Date.now()}`,
              name: feature.properties.name || `ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ${index + 1}`,
              longitude: feature.geometry.coordinates[0],
              latitude: feature.geometry.coordinates[1], 
              altitude: feature.geometry.coordinates[2] || feature.properties.altitude || 50,
              type: feature.properties.type || 'unknown',
              source: filename
          }));
      } else if (Array.isArray(data)) {
          objects = data.map((item, index) => ({
              id: `${filename}_${index}_${Date.now()}`,
              name: item.name || `ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ${index + 1}`,
              longitude: parseFloat(item.longitude || item.lng),
              latitude: parseFloat(item.latitude || item.lat),
              altitude: parseFloat(item.altitude || item.height) || 50,
              type: item.type || 'unknown',
              source: filename
          }));
      }
      
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã—ã¦è¿½åŠ 
      let addedCount = 0;
      objects.forEach(newObject => {
          const exists = loadedObjects.some(existing => 
              Math.abs(existing.longitude - newObject.longitude) < 0.00001 &&
              Math.abs(existing.latitude - newObject.latitude) < 0.00001
          );
          
          if (!exists) {
              loadedObjects.push(newObject);
              addedCount++;
          }
      });
      
      console.log(`JSONè§£æå®Œäº†: ${filename} ã‹ã‚‰ ${addedCount}ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ `);
  }

  // è¡¨ç¤ºæ›´æ–°
  function updateDisplay() {
      console.log('è¡¨ç¤ºæ›´æ–°é–‹å§‹:', loadedObjects.length, 'å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ');
      
      const features = loadedObjects.map(obj => ({
          type: 'Feature',
          geometry: {
              type: 'Point',
              coordinates: [obj.longitude, obj.latitude]
          },
          properties: {
              id: obj.id,
              name: obj.name,
              altitude: obj.altitude,
              type: obj.type
          }
      }));

      console.log('ä½œæˆã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼:', features.length, 'å€‹');
      console.log('æœ€åˆã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼:', features[0]);

      if (map && map.getSource('objects-3d')) {
          try {
              map.getSource('objects-3d').setData({
                  type: 'FeatureCollection',
                  features: features
              });
              console.log('ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†');
          } catch (error) {
              console.error('ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          }
      } else {
          console.warn('ãƒãƒƒãƒ—ã¾ãŸã¯ã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }

      updateStats();
      updateObjectList();
      updateButtonStates();
  }

  // çµ±è¨ˆæ›´æ–°
  function updateStats() {
      document.getElementById('loadedCount').textContent = loadedObjects.length;
      document.getElementById('visibleCount').textContent = loadedObjects.length;
      
      if (loadedObjects.length > 0) {
          const altitudes = loadedObjects.map(obj => obj.altitude);
          const minAlt = Math.min(...altitudes);
          const maxAlt = Math.max(...altitudes);
          document.getElementById('altitudeRange').textContent = `${minAlt.toFixed(0)}m - ${maxAlt.toFixed(0)}m`;
      } else {
          document.getElementById('altitudeRange').textContent = '-';
      }
  }

  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  function focusOnObject(objectId) {
      const obj = loadedObjects.find(o => o.id === objectId);
      if (obj) {
          map.flyTo({
              center: [obj.longitude, obj.latitude],
              zoom: 16,
              duration: 1500
          });
          
          // ä¸€æ™‚çš„ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
          new maplibregl.Popup({ closeOnClick: true })
              .setLngLat([obj.longitude, obj.latitude])
              .setHTML(`
                  <div style="padding: 8px;">
                      <h4 style="margin: 0 0 5px 0;">${obj.name}</h4>
                      <p style="margin: 0; font-size: 12px;">ã‚¿ã‚¤ãƒ—: ${obj.type} | é«˜åº¦: ${obj.altitude.toFixed(0)}m</p>
                  </div>
              `)
              .addTo(map);
          
          setStatus(`${obj.name}ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹`);
      }
  }

  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆæ›´æ–°
  function updateObjectList() {
      const objectList = document.getElementById('objectList');
      objectList.innerHTML = '';
      
      if (loadedObjects.length === 0) {
          objectList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
      }
      
      // ã‚¿ã‚¤ãƒ—åˆ¥ã§ã‚½ãƒ¼ãƒˆ
      const sortedObjects = [...loadedObjects].sort((a, b) => {
          if (a.type !== b.type) {
              return a.type.localeCompare(b.type);
          }
          return a.name.localeCompare(b.name);
      });
      
      sortedObjects.forEach(obj => {
          const item = document.createElement('div');
          item.className = 'object-item';
          item.innerHTML = `
              <div class="object-info">
                  <div class="object-name">
                      <span class="type-badge type-${obj.type}">${obj.type}</span>
                      ${obj.name}
                  </div>
                  <div class="object-details">
                      åº§æ¨™: ${obj.longitude.toFixed(6)}, ${obj.latitude.toFixed(6)}
                      <br>é«˜åº¦: ${obj.altitude.toFixed(0)}m | ã‚½ãƒ¼ã‚¹: ${obj.source}
                  </div>
              </div>
              <div class="object-actions">
                  <button class="action-btn focus-btn" onclick="focusOnObject('${obj.id}')" title="åœ°å›³ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹">ğŸ“</button>
                  <button class="action-btn delete-btn" onclick="removeObject('${obj.id}')" title="å‰Šé™¤">ğŸ—‘ï¸</button>
              </div>
          `;
          objectList.appendChild(item);
      });
  }

  // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
  function updateButtonStates() {
      const hasData = loadedObjects.length > 0;
      document.getElementById('exportCSVBtn').disabled = !hasData;
      document.getElementById('exportGeoJSONBtn').disabled = !hasData;
  }

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  function loadSampleData() {
      if (sampleDataLoaded) {
          setStatus('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã§ã™');
          return;
      }
      
      const center = [138.69, 35.3];
      const sampleData = [];
      
      // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‰ãƒ­ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
      for (let i = 1; i <= 5; i++) {
          const pos = generateRandomPosition(center, 2000); // 2kmç¯„å›²
          sampleData.push({
              id: `sample_drone_${i}_${Date.now()}`,
              name: `ãƒ‰ãƒ­ãƒ¼ãƒ³${String(i).padStart(3, '0')}`,
              longitude: pos[0],
              latitude: pos[1],
              altitude: 80 + Math.random() * 120, // 80-200m
              type: 'drone',
              source: 'sample'
          });
      }
      
      // ãã®ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      const otherTypes = [
          { type: 'base', name: 'åŸºåœ°å±€', altitude: 50 },
          { type: 'sensor', name: 'ã‚»ãƒ³ã‚µãƒ¼', altitude: 30 },
          { type: 'weather', name: 'æ°—è±¡è¦³æ¸¬', altitude: 100 },
          { type: 'building', name: 'å»ºç‰©', altitude: 150 }
      ];
      
      otherTypes.forEach((typeInfo, index) => {
          const pos = generateRandomPosition(center, 1500);
          sampleData.push({
              id: `sample_${typeInfo.type}_${index}_${Date.now()}`,
              name: `${typeInfo.name}${String(index + 1).padStart(2, '0')}`,
              longitude: pos[0],
              latitude: pos[1],
              altitude: typeInfo.altitude + (Math.random() - 0.5) * 40,
              type: typeInfo.type,
              source: 'sample'
          });
      });
      
      loadedObjects = loadedObjects.concat(sampleData);
      sampleDataLoaded = true;
      updateDisplay();
      setStatus(`ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${sampleData.length}ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ`);
  }

  // ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  function startDroneSimulation() {
      if (droneSimulationInterval) {
          clearInterval(droneSimulationInterval);
          droneSimulationInterval = null;
          setStatus('ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢');
          return;
      }
      
      const drones = loadedObjects.filter(obj => obj.type === 'drone');
      if (drones.length === 0) {
          setStatus('ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
          return;
      }
      
      setStatus('ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
      const trails = {};
      
      droneSimulationInterval = setInterval(() => {
          drones.forEach(drone => {
              // è»Œè·¡ä¿å­˜
              if (!trails[drone.id]) {
                  trails[drone.id] = [];
              }
              trails[drone.id].push([drone.longitude, drone.latitude]);
              
              // ãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•
              drone.longitude += (Math.random() - 0.5) * 0.002;
              drone.latitude += (Math.random() - 0.5) * 0.002;
              drone.altitude += (Math.random() - 0.5) * 20;
              drone.altitude = Math.max(50, Math.min(300, drone.altitude));
          });
          
          // è»Œè·¡æ›´æ–°
          const trailFeatures = Object.entries(trails).map(([droneId, coords]) => ({
              type: 'Feature',
              geometry: {
                  type: 'LineString',
                  coordinates: coords.slice(-20) // æœ€æ–°20ãƒã‚¤ãƒ³ãƒˆ
              },
              properties: { drone_id: droneId }
          }));
          
          if (map && map.getSource('drone-trails')) {
              map.getSource('drone-trails').setData({
                  type: 'FeatureCollection',
                  features: trailFeatures
              });
          }
          
          updateDisplay();
      }, 1000);
  }

  // ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—é–¢æ•°
  function exportCSV() {
      if (loadedObjects.length === 0) {
          setStatus('æ›¸ãå‡ºã™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
      }
      
      try {
          let csv = 'longitude,latitude,altitude,name,type,source\n';
          loadedObjects.forEach(obj => {
              csv += `${obj.longitude},${obj.latitude},${obj.altitude},"${obj.name}",${obj.type},"${obj.source}"\n`;
          });
          
          downloadFile(csv, 'maplibre_3d_data.csv', 'text/csv');
          setStatus('CSVæ›¸ãå‡ºã—å®Œäº†');
      } catch (error) {
          console.error('CSVæ›¸ãå‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
          setStatus('CSVæ›¸ãå‡ºã—ã‚¨ãƒ©ãƒ¼');
      }
  }

  function exportGeoJSON() {
      if (loadedObjects.length === 0) {
          setStatus('æ›¸ãå‡ºã™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
      }
      
      try {
          const geojson = {
              type: 'FeatureCollection',
              metadata: {
                  export_time: new Date().toISOString(),
                  total_objects: loadedObjects.length,
                  generator: 'MapLibre 3D System'
              },
              features: loadedObjects.map(obj => ({
                  type: 'Feature',
                  geometry: {
                      type: 'Point',
                      coordinates: [obj.longitude, obj.latitude, obj.altitude]
                  },
                  properties: {
                      name: obj.name,
                      type: obj.type,
                      altitude: obj.altitude,
                      source: obj.source,
                      id: obj.id
                  }
              }))
          };
          
          downloadFile(JSON.stringify(geojson, null, 2), 'maplibre_3d_data.geojson', 'application/geo+json');
          setStatus('GeoJSONæ›¸ãå‡ºã—å®Œäº†');
      } catch (error) {
          console.error('GeoJSONæ›¸ãå‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
          setStatus('GeoJSONæ›¸ãå‡ºã—ã‚¨ãƒ©ãƒ¼');
      }
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  function downloadFile(content, filename, mimeType) {
      try {
          const blob = new Blob([content], { type: mimeType });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          console.log(`ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${filename}`);
      } catch (error) {
          console.error('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
          setStatus(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
  function clearAllData() {
      if (loadedObjects.length === 0) {
          setStatus('ã‚¯ãƒªã‚¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
      }
      
      if (confirm(`${loadedObjects.length}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
          loadedObjects = [];
          sampleDataLoaded = false;
          
          // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
          if (droneSimulationInterval) {
              clearInterval(droneSimulationInterval);
              droneSimulationInterval = null;
          }
          
          // ãƒãƒƒãƒ—ã‚¯ãƒªã‚¢
          if (map && map.getSource('objects-3d')) {
              map.getSource('objects-3d').setData({
                  type: 'FeatureCollection',
                  features: []
              });
          }
          if (map && map.getSource('drone-trails')) {
              map.getSource('drone-trails').setData({
                  type: 'FeatureCollection',
                  features: []
              });
          }
          
          updateDisplay();
          setStatus('å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
      }
  }

  // 2D/3Dåˆ‡ã‚Šæ›¿ãˆ
  function toggle3D() {
      is3D = !is3D;
      
      if (is3D) {
          map.easeTo({ pitch: 70, duration: 1000 });
          if (map.getLayer('objects-3d-layer')) {
              map.setLayoutProperty('objects-3d-layer', 'visibility', 'visible');
          }
          if (map.getLayer('objects-points-layer')) {
              map.setLayoutProperty('objects-points-layer', 'visibility', 'none');
          }
          setStatus('3Dè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ');
      } else {
          map.easeTo({ pitch: 0, duration: 1000 });
          if (map.getLayer('objects-3d-layer')) {
              map.setLayoutProperty('objects-3d-layer', 'visibility', 'none');
          }
          if (map.getLayer('objects-points-layer')) {
              map.setLayoutProperty('objects-points-layer', 'visibility', 'visible');
          }
          setStatus('2Dè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ');
      }
  }

  // æç”»ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
  function enableDrawMode() {
      drawMode = !drawMode;
      
      if (drawMode) {
          map.getCanvas().style.cursor = 'crosshair';
          setStatus('æç”»ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ - ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ');
      } else {
          map.getCanvas().style.cursor = '';
          setStatus('æç”»ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹');
      }
  }

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', () => {
      console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†ã€åˆæœŸåŒ–é–‹å§‹');
      try {
          // å°‘ã—é…å»¶ã•ã›ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå®‰å®šã—ã¦ã‹ã‚‰åˆæœŸåŒ–
          setTimeout(() => {
              initializeMap();
              setupFileHandling();
              setStatus('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
              console.log('MapLibre 3Dãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
          }, 100);
      } catch (error) {
          console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
          setStatus('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼');
      }
  });

  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  window.addEventListener('error', (e) => {
      console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', e.error);
      setStatus(`ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${e.error.message}`);
  });

  // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ä½¿ç”¨å¯èƒ½ï¼‰
  window.mapLibreDebug = {
      map: () => map,
      objects: () => loadedObjects,
      export: () => ({ exportCSV, exportGeoJSON }),
      simulate: startDroneSimulation,
      clear: clearAllData
  };

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦éœ²å‡ºï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼‰
  window.loadSampleData = loadSampleData;
  window.startDroneSimulation = startDroneSimulation;
  window.exportCSV = exportCSV;
  window.exportGeoJSON = exportGeoJSON;
  window.clearAllData = clearAllData;
  window.toggle3D = toggle3D;
  window.enableDrawMode = enableDrawMode;
  window.removeObject = removeObject;
  window.focusOnObject = focusOnObject;
  </script>
</body>
</html>